# æµ‹è¯•è¾“å‡ºè¯¦è§£ - é€è¡Œè§£è¯»

## ğŸ“‹ ä½ çš„æµ‹è¯•å‘½ä»¤

```bash
forge test --match-path test/SimpleWallet.t.sol --match-test test_Prank_SimulateHacker_ShouldFail -vvv
```

**å‘½ä»¤è§£æ**ï¼š
- `forge test` - è¿è¡Œæµ‹è¯•
- `--match-path test/SimpleWallet.t.sol` - åªè¿è¡Œè¿™ä¸ªæ–‡ä»¶çš„æµ‹è¯•
- `--match-test test_Prank_SimulateHacker_ShouldFail` - åªè¿è¡Œè¿™ä¸ªæµ‹è¯•å‡½æ•°
- `-vvv` - æ˜¾ç¤ºè¯¦ç»†è¾“å‡ºï¼ˆåŒ…æ‹¬è°ƒç”¨æ ˆï¼‰

**âœ… å‘½ä»¤æ˜¯æ­£ç¡®çš„ï¼** è¿™ä¸ªå‘½ä»¤ä¼šç²¾ç¡®è¿è¡Œå•ä¸ªæµ‹è¯•ç”¨ä¾‹ã€‚

## ğŸ” è¾“å‡ºé€è¡Œè§£è¯»

### 1. ç¼–è¯‘é˜¶æ®µ

```
[â ’] Compiling...
[â ‘] Compiling 3 files with Solc 0.8.30
[â ˜] Solc 0.8.30 finished in 455.53ms
Compiler run successful!
```

**å«ä¹‰**ï¼š
- Foundry æ­£åœ¨ç¼–è¯‘ Solidity æ–‡ä»¶
- ä½¿ç”¨äº† Solc 0.8.30 ç¼–è¯‘å™¨
- ç¼–è¯‘äº† 3 ä¸ªæ–‡ä»¶ï¼ˆæµ‹è¯•æ–‡ä»¶ + ä¾èµ–ï¼‰
- ç¼–è¯‘æˆåŠŸ âœ…

### 2. æµ‹è¯•æ‰§è¡Œç»“æœ

```
Ran 1 test for test/SimpleWallet.t.sol:SimpleWalletTest
[FAIL: Balance should still be 100 ETH: 0 != 100000000000000000000] 
test_Prank_SimulateHacker_ShouldFail() (gas: 18185)
```

**å«ä¹‰**ï¼š
- è¿è¡Œäº† 1 ä¸ªæµ‹è¯•ï¼ˆç¬¦åˆé¢„æœŸï¼Œå› ä¸ºæˆ‘ä»¬åªæŒ‡å®šäº†ä¸€ä¸ªæµ‹è¯•ï¼‰
- æµ‹è¯•å¤±è´¥äº† âŒ
- å¤±è´¥åŸå› ï¼šæœŸæœ›ä½™é¢æ˜¯ 100 ETHï¼Œä½†å®é™…æ˜¯ 0
- `100000000000000000000` = 100 ETHï¼ˆ1 ETH = 10^18 weiï¼‰
- `gas: 18185` - è¿™ä¸ªæµ‹è¯•æ¶ˆè€—äº† 18185 gas

### 3. è¯¦ç»†æ‰§è¡Œè½¨è¿¹ï¼ˆTracesï¼‰

```
Traces:
  [18185] SimpleWalletTest::test_Prank_SimulateHacker_ShouldFail()
```

**å«ä¹‰**ï¼šè¿™æ˜¯æµ‹è¯•å‡½æ•°çš„å®Œæ•´æ‰§è¡Œè½¨è¿¹ï¼Œæ€» gas æ¶ˆè€— 18185

#### æ­¥éª¤1ï¼šæ‰§è¡Œ prank

```
    â”œâ”€ [0] VM::prank(0x0000000000000000000000000000000000000999)
    â”‚   â””â”€ â† [Return]
```

**è§£è¯»**ï¼š
- `VM::prank` - è°ƒç”¨ Foundry çš„è™šæ‹Ÿæœºä½œå¼Šç 
- `0x0000000000000000000000000000000000000999` - hacker åœ°å€ï¼ˆå°±æ˜¯ `address(0x999)`ï¼‰
- `[0]` - è¿™ä¸€æ­¥æ¶ˆè€— 0 gasï¼ˆVM æ“ä½œä¸æ¶ˆè€— gasï¼‰
- `[Return]` - æ‰§è¡ŒæˆåŠŸ âœ…
- **ä½œç”¨**ï¼šè®©ä¸‹ä¸€è¡Œä»£ç çš„ `msg.sender` å˜æˆ hacker

#### æ­¥éª¤2ï¼šè®¾ç½®æœŸæœ› revert

```
    â”œâ”€ [0] VM::expectRevert(custom error 0xf28dceb3:  Only owner can withdraw!)
    â”‚   â””â”€ â† [Return]
```

**è§£è¯»**ï¼š
- `VM::expectRevert` - å‘Šè¯‰ Foundryï¼šä¸‹ä¸€è¡Œä»£ç åº”è¯¥ revert
- `Only owner can withdraw!` - æœŸæœ›çš„é”™è¯¯ä¿¡æ¯
- `0xf28dceb3` - é”™è¯¯ä¿¡æ¯çš„å“ˆå¸Œå€¼
- **ä½œç”¨**ï¼šå¦‚æœä¸‹ä¸€è¡Œä»£ç ä¸ revertï¼Œæˆ–è€… revert ä¿¡æ¯ä¸å¯¹ï¼Œæµ‹è¯•ä¼šå¤±è´¥

#### æ­¥éª¤3ï¼šå°è¯•æå–èµ„é‡‘ï¼ˆåº”è¯¥å¤±è´¥ï¼‰

```
    â”œâ”€ [2851] SimpleWallet::withdraw(50000000000000000000 [5e19])
    â”‚   â””â”€ â† [Revert] Only owner can withdraw!
```

**è§£è¯»**ï¼š
- `SimpleWallet::withdraw` - è°ƒç”¨é’±åŒ…çš„ withdraw å‡½æ•°
- `50000000000000000000 [5e19]` - å‚æ•°æ˜¯ 50 ETHï¼ˆ5e19 = 5 Ã— 10^19 weiï¼‰
- `[2851]` - è¿™ä¸€æ­¥æ¶ˆè€—äº† 2851 gasï¼ˆåœ¨ revert ä¹‹å‰ï¼‰
- `[Revert] Only owner can withdraw!` - ç¡®å® revert äº†ï¼Œé”™è¯¯ä¿¡æ¯æ­£ç¡® âœ…
- **ç»“æœ**ï¼šç¬¦åˆé¢„æœŸï¼é»‘å®¢å°è¯•æå–å¤±è´¥

#### æ­¥éª¤4ï¼šæ£€æŸ¥ä½™é¢ï¼ˆé—®é¢˜åœ¨è¿™é‡Œï¼ï¼‰

```
    â”œâ”€ [2410] SimpleWallet::getBalance() [staticcall]
    â”‚   â””â”€ â† [Return] 0
```

**è§£è¯»**ï¼š
- `SimpleWallet::getBalance()` - è°ƒç”¨é’±åŒ…çš„ getBalance å‡½æ•°
- `[staticcall]` - è¿™æ˜¯ä¸€ä¸ªåªè¯»è°ƒç”¨ï¼ˆä¸ä¿®æ”¹çŠ¶æ€ï¼‰
- `[2410]` - æ¶ˆè€—äº† 2410 gas
- `[Return] 0` - è¿”å› 0 âŒ **é—®é¢˜åœ¨è¿™é‡Œï¼**
- **æœŸæœ›**ï¼šåº”è¯¥è¿”å› 100 ETHï¼ˆ100000000000000000000 weiï¼‰
- **å®é™…**ï¼šè¿”å› 0

#### æ­¥éª¤5ï¼šæ–­è¨€å¤±è´¥

```
    â”œâ”€ [0] VM::assertEq(0, 100000000000000000000 [1e20], "Balance should still be 100 ETH") [staticcall]
    â”‚   â””â”€ â† [Revert] Balance should still be 100 ETH: 0 != 100000000000000000000
```

**è§£è¯»**ï¼š
- `VM::assertEq` - Foundry çš„æ–­è¨€å‡½æ•°ï¼ˆæ¯”è¾ƒä¸¤ä¸ªå€¼æ˜¯å¦ç›¸ç­‰ï¼‰
- å‚æ•°1ï¼š`0` - å®é™…å€¼ï¼ˆgetBalance() è¿”å›çš„å€¼ï¼‰
- å‚æ•°2ï¼š`100000000000000000000 [1e20]` - æœŸæœ›å€¼ï¼ˆ100 ETHï¼‰
- å‚æ•°3ï¼š`"Balance should still be 100 ETH"` - é”™è¯¯ä¿¡æ¯
- `[Revert]` - æ–­è¨€å¤±è´¥ï¼Œæµ‹è¯• revert
- **åŸå› **ï¼š0 â‰  100 ETH

### 4. æµ‹è¯•å¥—ä»¶ç»“æœ

```
Suite result: FAILED. 0 passed; 1 failed; 0 skipped; finished in 7.70ms (5.93ms CPU time)
```

**å«ä¹‰**ï¼š
- æµ‹è¯•å¥—ä»¶å¤±è´¥
- 0 ä¸ªé€šè¿‡ï¼Œ1 ä¸ªå¤±è´¥ï¼Œ0 ä¸ªè·³è¿‡
- æ€»è€—æ—¶ 7.70ms

### 5. æ€»ç»“

```
Ran 1 test suite in 16.09ms (7.70ms CPU time): 0 tests passed, 1 failed, 0 skipped (1 total tests)

Failing tests:
Encountered 1 failing test in test/SimpleWallet.t.sol:SimpleWalletTest
[FAIL: Balance should still be 100 ETH: 0 != 100000000000000000000] 
test_Prank_SimulateHacker_ShouldFail() (gas: 18185)

Encountered a total of 1 failing tests, 0 tests succeeded
```

**å«ä¹‰**ï¼š
- è¿è¡Œäº† 1 ä¸ªæµ‹è¯•å¥—ä»¶
- 1 ä¸ªæµ‹è¯•å¤±è´¥
- å¤±è´¥åŸå› æ€»ç»“

## ğŸ¯ å…³é”®ç†è§£

### 1. æµ‹è¯•é€»è¾‘æ˜¯æ­£ç¡®çš„

- âœ… prank æ‰§è¡ŒæˆåŠŸ
- âœ… withdraw ç¡®å® revert äº†ï¼ˆç¬¦åˆé¢„æœŸï¼‰
- âŒ ä½†æ˜¯ä½™é¢æ£€æŸ¥å¤±è´¥ï¼ˆå› ä¸º setUp æœ‰é—®é¢˜ï¼‰

### 2. é—®é¢˜æ ¹æº

`vm.deal()` åªç»™åœ°å€åˆ†é… ETHï¼Œ**ä¸ä¼šè§¦å‘åˆçº¦çš„ `receive()` å‡½æ•°**ï¼Œæ‰€ä»¥åˆçº¦çš„ `balance` å˜é‡æ²¡æœ‰æ›´æ–°ã€‚

### 3. ä¿®å¤æ–¹æ³•

éœ€è¦å®é™…å‘åˆçº¦è½¬è´¦ï¼Œè§¦å‘ `receive()` å‡½æ•°ï¼š

```solidity
function setUp() public {
    wallet = new SimpleWallet(owner);
    vm.deal(address(this), 100 ether);  // ç»™æµ‹è¯•åˆçº¦ ETH
    payable(address(wallet)).transfer(100 ether);  // è½¬è´¦ï¼Œè§¦å‘ receive()
}
```

## âœ… ä¿®å¤ååº”è¯¥çœ‹åˆ°çš„è¾“å‡º

```
[PASS] test_Prank_SimulateHacker_ShouldFail() (gas: xxxxx)
```

ä½™é¢æ£€æŸ¥ä¼šé€šè¿‡ï¼Œå› ä¸º `wallet.getBalance()` ç°åœ¨ä¼šè¿”å› 100 ETHã€‚
