# æµ‹è¯•å¤±è´¥åŸå› è¯¦ç»†åˆ†æ

## ğŸ” é—®é¢˜åˆ†æ

### æµ‹è¯•è¾“å‡ºè§£è¯»

```
[FAIL: Balance should still be 100 ETH: 0 != 100000000000000000000] 
test_Prank_SimulateHacker_ShouldFail() (gas: 18185)
```

**é”™è¯¯ä¿¡æ¯**ï¼šæœŸæœ›ä½™é¢æ˜¯ 100 ETHï¼Œä½†å®é™…æ˜¯ 0

### Trace åˆ†æï¼ˆæ‰§è¡Œæµç¨‹ï¼‰

```
[18185] SimpleWalletTest::test_Prank_SimulateHacker_ShouldFail()
    â”œâ”€ [0] VM::prank(0x0000000000000000000000000000000000000999)
    â”‚   â””â”€ â† [Return]  âœ… prank æ‰§è¡ŒæˆåŠŸï¼Œä¸‹ä¸€è¡Œä»£ç çš„è°ƒç”¨è€…å˜æˆ hacker
    â”‚
    â”œâ”€ [0] VM::expectRevert(custom error 0xf28dceb3:  Only owner can withdraw!)
    â”‚   â””â”€ â† [Return]  âœ… è®¾ç½®æœŸæœ›ï¼šä¸‹ä¸€è¡Œä»£ç åº”è¯¥ revert
    â”‚
    â”œâ”€ [2851] SimpleWallet::withdraw(50000000000000000000 [5e19])
    â”‚   â””â”€ â† [Revert] Only owner can withdraw!  âœ… ç¡®å® revert äº†ï¼ˆç¬¦åˆé¢„æœŸï¼‰
    â”‚
    â”œâ”€ [2410] SimpleWallet::getBalance() [staticcall]
    â”‚   â””â”€ â† [Return] 0  âŒ é—®é¢˜åœ¨è¿™é‡Œï¼ä½™é¢æ˜¯ 0ï¼Œä¸æ˜¯ 100 ETH
    â”‚
    â”œâ”€ [0] VM::assertEq(0, 100000000000000000000 [1e20], ...)
    â”‚   â””â”€ â† [Revert] Balance should still be 100 ETH: 0 != 100000000000000000000
    â”‚   âŒ æ–­è¨€å¤±è´¥ï¼šæœŸæœ› 100 ETHï¼Œå®é™… 0
    â”‚
    â””â”€ â† [Revert] æµ‹è¯•å¤±è´¥
```

## ğŸ› æ ¹æœ¬åŸå› 

### é—®é¢˜ä»£ç 

```solidity
function setUp() public {
    wallet = new SimpleWallet(owner);
    vm.deal(address(wallet), 100 ether);  // âŒ é—®é¢˜åœ¨è¿™é‡Œï¼
}
```

### ä¸ºä»€ä¹ˆ `vm.deal()` ä¸è¡Œï¼Ÿ

`vm.deal(address, amount)` çš„ä½œç”¨ï¼š
- âœ… ç»™åœ°å€åˆ†é… ETHï¼ˆåœ°å€çš„ä½™é¢å˜æˆ 100 ETHï¼‰
- âŒ **ä¸ä¼šè§¦å‘åˆçº¦çš„ `receive()` å‡½æ•°**
- âŒ **ä¸ä¼šæ›´æ–°åˆçº¦çš„ `balance` å˜é‡**

### åˆçº¦ä»£ç å›é¡¾

```solidity
contract SimpleWallet {
    uint256 public balance;  // è¿™ä¸ªå˜é‡éœ€è¦é€šè¿‡ receive() æ¥æ›´æ–°
    
    receive() external payable {
        balance += msg.value;  // åªæœ‰è°ƒç”¨ receive() æ‰ä¼šæ›´æ–° balance
    }
    
    function getBalance() public view returns (uint256) {
        return balance;  // è¿”å›çš„æ˜¯ balance å˜é‡ï¼Œä¸æ˜¯ address(this).balance
    }
}
```

### å®é™…æƒ…å†µ

- `address(wallet).balance` = 100 ETH âœ…ï¼ˆåœ°å€ç¡®å®æœ‰ ETHï¼‰
- `wallet.balance` = 0 âŒï¼ˆå˜é‡æ²¡æœ‰æ›´æ–°ï¼Œå› ä¸º `receive()` æ²¡è¢«è°ƒç”¨ï¼‰
- `wallet.getBalance()` = 0 âŒï¼ˆè¿”å›çš„æ˜¯ `balance` å˜é‡ï¼‰

## âœ… è§£å†³æ–¹æ¡ˆ

éœ€è¦å®é™…å‘åˆçº¦è½¬è´¦ï¼Œè§¦å‘ `receive()` å‡½æ•°ï¼š

```solidity
function setUp() public {
    wallet = new SimpleWallet(owner);
    
    // æ–¹æ³•1ï¼šä½¿ç”¨ vm.deal + å®é™…è½¬è´¦
    vm.deal(address(this), 100 ether);  // å…ˆç»™æµ‹è¯•åˆçº¦ä¸€äº› ETH
    (bool success, ) = address(wallet).call{value: 100 ether}("");  // è½¬è´¦ç»™é’±åŒ…
    require(success, "Transfer failed");
    
    // æ–¹æ³•2ï¼šæ›´ç®€å•çš„æ–¹å¼ - ç›´æ¥ç»™åœ°å€ ETHï¼Œç„¶åæ¨¡æ‹Ÿè°ƒç”¨ receive
    vm.deal(address(wallet), 100 ether);
    vm.prank(address(this));
    (bool success2, ) = address(wallet).call{value: 100 ether}("");
    require(success2, "Transfer failed");
    
    // æ–¹æ³•3ï¼šæœ€ç®€å• - ä½¿ç”¨ vm.deal ç»™æµ‹è¯•åˆçº¦ï¼Œç„¶åè½¬è´¦
    vm.deal(address(this), 100 ether);
    payable(address(wallet)).transfer(100 ether);
}
```

## ğŸ“Š å¯¹æ¯”ï¼švm.deal vs å®é™…è½¬è´¦

| æ–¹å¼ | åœ°å€ä½™é¢ | receive() è¢«è°ƒç”¨ | balance å˜é‡æ›´æ–° |
|------|---------|-----------------|----------------|
| `vm.deal(address, amount)` | âœ… æœ‰ ETH | âŒ ä¸è°ƒç”¨ | âŒ ä¸æ›´æ–° |
| å®é™…è½¬è´¦ | âœ… æœ‰ ETH | âœ… ä¼šè°ƒç”¨ | âœ… ä¼šæ›´æ–° |

## ğŸ¯ ä¿®å¤åçš„ä»£ç 

```solidity
function setUp() public {
    wallet = new SimpleWallet(owner);
    
    // ç»™æµ‹è¯•åˆçº¦ä¸€äº› ETH
    vm.deal(address(this), 100 ether);
    
    // å®é™…å‘é’±åŒ…åˆçº¦è½¬è´¦ï¼Œè§¦å‘ receive() å‡½æ•°
    payable(address(wallet)).transfer(100 ether);
    
    // ç°åœ¨ wallet.getBalance() ä¼šè¿”å› 100 ether âœ…
}
```

## ğŸ” å¦‚ä½•éªŒè¯ä¿®å¤

è¿è¡Œæµ‹è¯•åï¼Œåº”è¯¥çœ‹åˆ°ï¼š

```
[PASS] test_Prank_SimulateHacker_ShouldFail() (gas: xxxxx)
```

ä½™é¢æ£€æŸ¥åº”è¯¥é€šè¿‡ï¼š
- `wallet.getBalance()` = 100 ether âœ…
- `assertEq(wallet.getBalance(), 100 ether)` âœ…
